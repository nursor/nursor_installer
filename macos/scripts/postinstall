#!/bin/bash

# Postinstall script for Nursor
# This script runs after all files have been copied to their destination.
# It runs as root.
if [ -z "$COMMAND_LINE_INSTALL" ]; then
  echo "正在通过 GUI 安装器运行安装脚本" 
else
  echo "正在通过命令行 installer 安装" > /tmp/install_debug.log
fi

echo "INSTALL_ROOT_DIR = '$2'" >> /tmp/postinstall_debug.txt


echo "Nursor Installer: Running postinstall script..."
LOG_FILE="/var/log/nursor_install_log.log" # 定义日志文件路径
echo "Nursor Installer: Running postinstall script..." >> "${LOG_FILE}"

# --- 1. 定义路径 ---
# $2 是安装目标根目录 (通常是 /)
INSTALL_ROOT_DIR="$2"
APP_NAME="Nursor.app"
CORE_BINARY_NAME="nursor-core"
LAUNCHD_PLIST_NAME="org.nursor.nursor-core.plist"
TRUSTCA_PLIST_NAME="org.nursor.trustca.plist"
CA_ONCE_SH_NAME="trust_ca_once.sh"

APP_DEST_PATH="${INSTALL_ROOT_DIR}/Applications/${APP_NAME}"
CORE_DEST_DIR="${INSTALL_ROOT_DIR}/Library/Application Support/Nursor"
CORE_DEST_PATH="${CORE_DEST_DIR}/${CORE_BINARY_NAME}"
LAUNCHD_DEST_PATH="${INSTALL_ROOT_DIR}/Library/LaunchDaemons/${LAUNCHD_PLIST_NAME}"
CA_PEM_DEST_PATH="${CORE_DEST_DIR}/${CA_PEM_NAME}"
TRUSTCA_DEST_PATH="${INSTALL_ROOT_DIR}/Library/LaunchDaemons/${TRUSTCA_PLIST_NAME}"
CA_ONCE_DEST_PATH="${CORE_DEST_DIR}/${CA_ONCE_SH_NAME}"

# --- 2. 确保 CA 证书文件存在并设置权限 ---
echo "Ensuring CA certificate file exists and has correct permissions: ${CA_PEM_DEST_PATH}" >> "${LOG_FILE}"
mkdir -p "${CA_PEM_DEST_PATH}"
chmod 755 "${CA_PEM_DEST_PATH}"

chmod 644 "${TRUSTCA_DEST_PATH}"
chown root:wheel "${TRUSTCA_DEST_PATH}"

echo "CA certificate added successfully." >> "${LOG_FILE}"

# --- 2. 确保核心二进制文件目录存在并设置权限 ---
# pkgbuild 会复制文件，但这里额外确保目录权限，防止意外
echo "Ensuring core binary directory exists and has correct permissions: ${CORE_DEST_DIR}" >> "${LOG_FILE}"
mkdir -p "${CORE_DEST_DIR}"
chmod 755 "${CORE_DEST_DIR}"
chown root:wheel "${CORE_DEST_DIR}"
if [ $? -ne 0 ]; then
    echo "ERROR: Failed to set permissions for ${CORE_DEST_DIR}." >> "${LOG_FILE}"
    exit 1
fi

# --- 3. 设置核心二进制文件权限 ---
echo "Setting permissions for core binary: ${CORE_DEST_PATH}" >> "${LOG_FILE}"
chmod 755 "${CORE_DEST_PATH}" # 确保可执行
chown root:wheel "${CORE_DEST_PATH}" # 确保所有者为 root
if [ $? -ne 0 ]; then
    echo "ERROR: Failed to set permissions for ${CORE_DEST_PATH}." >> "${LOG_FILE}"
    exit 1
fi

# --- 4. 设置 Launchd Plist 文件权限 ---
echo "Setting permissions for Launchd Plist: ${LAUNCHD_DEST_PATH}" >> "${LOG_FILE}"
chmod 644 "${LAUNCHD_DEST_PATH}" # Plist 文件权限
chown root:wheel "${LAUNCHD_DEST_PATH}" # 所有者为 root
if [ $? -ne 0 ]; then
    echo "ERROR: Failed to set permissions for ${LAUNCHD_DEST_PATH}." >> "${LOG_FILE}"
    exit 1
fi

# --- 5. 注册并加载 Launchd 服务 ---
echo "Loading Launchd service: ${LAUNCHD_PLIST_NAME}" >> "${LOG_FILE}"
# 卸载旧服务（如果存在），忽略错误
launchctl bootout system "${LAUNCHD_DEST_PATH}" 2>/dev/null || true
launchctl bootstrap system "${LAUNCHD_DEST_PATH}"
if [ $? -ne 0 ]; then
    echo "ERROR: Failed to load Launchd service. Check logs for details." >> "${LOG_FILE}"
    echo "Please check /var/log/nursor-core.log for more information." >> "${LOG_FILE}"
    exit 1
fi
echo "Launchd service registered and loaded successfully." >> "${LOG_FILE}"

echo "Nursor Installer: Postinstall script finished." >> "${LOG_FILE}"

exit 0