name: Build macOS (macos installer)

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      flutter_ref:
        required: false
        type: string
      core_ref:
        required: false
        type: string

# 如果你需要改 repo 名，把下面两个 env 改成你的 repo
env:
  FLUTTER_REPO: nursor/nursor-flutter-app
  CORE_REPO: nursor/nursor-core2

jobs:
  build-macos:
    # 双架构矩阵：amd64（intel）和 arm64（apple silicon）
    strategy:
      matrix:
        arch: [amd64, arm64]
      fail-fast: false
    # macos-14/macos-latest 都可；注意：macos runner 的实际硬件架构可能与 matrix 不匹配
    runs-on: macos-14

    permissions:
      contents: read
      packages: write

    steps:
      - name: Print context info
        run: |
          echo "Job started on runner: $RUNNER_OS / $(uname -m)"
          echo "Requested matrix arch: ${{ matrix.arch }}"
          echo "Inputs: version=${{ inputs.version }}, flutter_ref=${{ inputs.flutter_ref }}, core_ref=${{ inputs.core_ref }}"

      - name: Checkout packaging repo (this repo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure runner arch compatibility (best-effort)
        id: arch_check
        run: |
          RUNNER_ARCH=$(uname -m)
          echo "Runner architecture: $RUNNER_ARCH"
          if [ "${{ matrix.arch }}" = "amd64" ]; then
            # intel on mac is x86_64
            if [ "$RUNNER_ARCH" != "x86_64" ]; then
              echo "WARNING: Requested amd64 build but runner is $RUNNER_ARCH."
              echo "If you require Intel macOS builds, please provide a self-hosted macOS x86_64 runner labeled accordingly."
              echo "arch_mismatch=true" >> $GITHUB_OUTPUT
            else
              echo "arch_mismatch=false" >> $GITHUB_OUTPUT
            fi
          else
            # arm64 expected
            if [ "$RUNNER_ARCH" != "arm64" ] && [ "$RUNNER_ARCH" != "aarch64" ]; then
              echo "WARNING: Requested arm64 build but runner is $RUNNER_ARCH."
              echo "arch_mismatch=true" >> $GITHUB_OUTPUT
            else
              echo "arch_mismatch=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          # map matrix.arch -> flutter-action arch param
          architecture: ${{ matrix.arch == 'amd64' && 'x64' || 'arm64' }}
          cache: true

      - name: Checkout Flutter app (source)
        uses: actions/checkout@v4
        with:
          repository: ${{ env.FLUTTER_REPO }}
          ref: ${{ inputs.flutter_ref || inputs.version }}
          path: flutter_app
          token: ${{ secrets.PACKAGING_REPO_TOKEN }}
          fetch-depth: 0

      - name: Build Flutter App for macOS
        working-directory: ./flutter_app
        run: |
          set -e
          echo "Flutter version: $(flutter --version)"
          flutter pub get
          # 指定 release，flutter 会根据 runner 的实际架构构建对应二进制（如果 runner 支持）
          flutter build macos --release
          # 确认产物路径并拷贝
          if [ -d "build/macos/Build/Products/Release/Nursor.app" ]; then
            mkdir -p ../macos
            cp -R build/macos/Build/Products/Release/Nursor.app ../macos/
            echo "✓ Nursor.app copied"
          else
            echo "ERROR: Flutter build output not found at build/macos/Build/Products/Release/Nursor.app"
            ls -lah build/macos || true
            exit 1
          fi

      - name: Download nursor-core (from core repo releases)
        run: |
          set -e
          CORE_REF="${{ inputs.core_ref || inputs.version }}"
          ARCH="${{ matrix.arch }}"
          mkdir -p macos
          CORE_URL="https://github.com/${{ env.CORE_REPO }}/releases/download/${CORE_REF}/core-darwin-${ARCH}"
          echo "Downloading core from: $CORE_URL"
          # 下载并对常见错误页面做初步检查
          curl -fsSL -o macos/nursor-core.tmp "$CORE_URL" || { echo "ERROR: curl failed downloading $CORE_URL"; exit 1; }
          # 判断是否为 HTML / JSON 错误页面（用前几字节检测）
          head_bytes=$(head -c 200 macos/nursor-core.tmp | tr -cd '\11\12\15\40-\176' | sed -n '1p' || true)
          if echo "$head_bytes" | grep -qiE "<!DOCTYPE|<html|{\"error\"|\"message\"" ; then
            echo "ERROR: Downloaded core appears to be an HTML/JSON error page. Aborting."
            echo "First bytes:"
            head -c 512 macos/nursor-core.tmp || true
            rm -f macos/nursor-core.tmp
            exit 1
          fi
          mv macos/nursor-core.tmp macos/nursor-core
          chmod +x macos/nursor-core
          echo "Downloaded core binary: macos/nursor-core"

          # 校验 checksum（如果存在）
          CHECKSUM_URL="https://github.com/${{ env.CORE_REPO }}/releases/download/${CORE_REF}/core-darwin-${ARCH}.sha256"
          if curl -fsSL "$CHECKSUM_URL" > /tmp/checksum.sha256 2>/dev/null; then
            echo "Found checksum file, verifying..."
            # checksum 文件格式一般是: <sha256>  filename
            SHA_EXPECTED=$(awk '{print $1}' /tmp/checksum.sha256)
            SHA_ACTUAL=$(shasum -a 256 macos/nursor-core | awk '{print $1}')
            echo "expected: $SHA_EXPECTED"
            echo "actual:   $SHA_ACTUAL"
            if [ "$SHA_EXPECTED" != "$SHA_ACTUAL" ]; then
              echo "ERROR: SHA256 mismatch"
              exit 1
            fi
            echo "SHA256 verified"
          else
            echo "WARNING: checksum not found, skipping verification"
          fi

      - name: Prepare macOS packaging directory & checks
        working-directory: ./macos
        run: |
          set -e
          echo "Working dir: $(pwd)"
          # 必需文件列表（你可以按需调整）
          REQUIRED_FILES=(
            "build_installer.sh"
            "nursor-core"
            "Nursor.app"
            "org.nursor.nursor-core.plist"
            "org.nursor.trustca.plist"
            "trust_ca_once.sh"
            "scripts/preinstall"
            "scripts/postinstall"
            "scripts/send_to_sentry.sh"
          )
          MISSING=()
          for f in "${REQUIRED_FILES[@]}"; do
            if [ ! -e "$f" ]; then
              MISSING+=("$f")
            fi
          done
          if [ ${#MISSING[@]} -gt 0 ]; then
            echo "ERROR: Missing required files:"
            for m in "${MISSING[@]}"; do echo " - $m"; done
            echo "Current dir listing:"
            ls -lah
            exit 1
          fi

          # 确保 build_installer.sh 可执行
          chmod +x build_installer.sh || true
          if [ ! -x build_installer.sh ]; then
            echo "ERROR: build_installer.sh is present but not executable"
            exit 1
          fi
          echo "Packaging files check passed"

      - name: Run build_installer.sh (absolute path) and verify output
        id: run_installer
        working-directory: ./macos
        run: |
          set -e
          MACOS_DIR="$(pwd)"
          SCRIPT_PATH="${MACOS_DIR}/build_installer.sh"
          echo "Running installer script: $SCRIPT_PATH"
          # 如果 runner 无法使用 sudo（或你不想使用 sudo），脚本应该能在普通用户下运行
          if command -v sudo >/dev/null 2>&1; then
            sudo -n true 2>/dev/null || echo "Note: sudo exists but may require password; many GitHub runners have passwordless sudo"
            sudo "$SCRIPT_PATH" || { echo "ERROR: installer script failed (sudo)"; exit 1; }
          else
            "$SCRIPT_PATH" || { echo "ERROR: installer script failed"; exit 1; }
          fi

          # 确保 output 目录存在并含有打包文件
          if [ ! -d "${MACOS_DIR}/output" ]; then
            echo "ERROR: output/ directory missing after installer run"
            ls -lah "${MACOS_DIR}" || true
            exit 1
          fi
          echo "Output contents:"
          ls -lah "${MACOS_DIR}/output" || true
          echo "installer_path=$(ls -1 ${MACOS_DIR}/output | head -n1 || true)" >> $GITHUB_OUTPUT

      - name: Upload macOS installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: nursor-installer-macos-${{ matrix.arch }}
          path: macos/output/*
          retention-days: 30

      - name: Create/Update GitHub Release (append body to avoid overwriting)
        if: always() && (startsWith(github.ref, 'refs/tags/') || github.event_name == 'repository_dispatch' || github.event_name == 'workflow_call')
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          files: macos/output/*
          tag_name: ${{ inputs.version }}
          name: Release ${{ inputs.version }}
          append_body: true
          body: |
            ## macOS Installer ({{ matrix.arch }})
            Build triggered from: ${{ github.event_name }}
            Flutter ref: ${{ inputs.flutter_ref || inputs.version }}
            Core ref: ${{ inputs.core_ref || inputs.version }}
