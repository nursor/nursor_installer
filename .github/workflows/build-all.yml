name: Build All Platforms

on:
  workflow_dispatch:
  push:
    tags: ['v*']
  repository_dispatch:
    types: [build-trigger]

jobs:
  detect-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
    steps:
      - name: Extract version from tag or dispatch
        id: extract
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "repository_dispatch" ]]; then
            echo "version=${{ github.event.client_payload.version }}" >> "$GITHUB_OUTPUT"
          elif [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
          else
            echo "version=dev" >> "$GITHUB_OUTPUT"
          fi

  build-linux:
    uses: ./.github/workflows/build-linux.yml
    secrets: inherit
    with:
      version: ${{ needs.detect-version.outputs.version }}
    needs: detect-version

  build-macos:
    uses: ./.github/workflows/build-macos.yml
    secrets: inherit
    with:
      version: ${{ needs.detect-version.outputs.version }}
    needs: detect-version

  build-windows:
    uses: ./.github/workflows/build-windows.yml
    secrets: inherit
    with:
      version: ${{ needs.detect-version.outputs.version }}
    needs: detect-version

  summary:
    runs-on: ubuntu-latest
    needs: [build-linux, build-macos, build-windows]
    steps:
      - name: Print build results
        run: |
          echo "âœ… Build summary:"
          echo "- Linux: ${{ needs.build-linux.result }}"
          echo "- macOS: ${{ needs.build-macos.result }}"
          echo "- Windows: ${{ needs.build-windows.result }}"

          