#!/bin/bash

# postinstall 脚本将以 root 权限运行
# 确保这个脚本是可执行的：chmod +x scripts/postinstall

echo "Nursor Installer: Running postinstall script..."

# 定义 CORE_BINARY_NAME, LAUNCHD_PLIST_NAME
# 这些变量在 build_installer.sh 中定义，但为了 postinstall 脚本的独立性，在此处再次定义。
CORE_BINARY_NAME="nursor-core"
LAUNCHD_PLIST_NAME="org.nursor.nursor-core.plist"

# 核心服务文件路径
CORE_BINARY_PATH="/Library/Application Support/Nursor/${CORE_BINARY_NAME}"
LAUNCHD_PLIST_PATH="/Library/LaunchDaemons/${LAUNCHD_PLIST_NAME}"

# 检查并加载 LaunchDaemons
echo "Nursor Installer: Loading LaunchDaemon..."
if [ -f "${LAUNCHD_PLIST_PATH}" ]; then
    # 卸载旧的（如果存在），然后加载新的
    launchctl unload "${LAUNCHD_PLIST_PATH}" 2>/dev/null
    launchctl load -w "${LAUNCHD_PLIST_PATH}"
    echo "Nursor Installer: LaunchDaemon ${LAUNCHD_PLIST_PATH} loaded."
else
    echo "WARNING: LaunchDaemon plist not found at ${LAUNCHD_PLIST_PATH}."
fi

# ====================================================================================
# 重要提示：
# 应用程序 (Nursor.app) 的安装和位置应完全由 pkgbuild 命令处理。
# PackageKit 的“重定位”行为是由于应用程序包内部的元数据导致的，
# 无法通过 postinstall 脚本手动纠正。
# 此脚本已移除所有尝试查找、移动或注册 Nursor.app 的逻辑。
# ====================================================================================

echo "Nursor Installer: Postinstall script finished."
