name: Build All Platforms

on:
  # ç›‘å¬å½“å‰ä»“åº“çš„tagäº‹ä»¶
  push:
    tags:
      - 'v*'
  # ç›‘å¬å…¶ä»–ä»“åº“é€šè¿‡repository_dispatchè§¦å‘çš„äº‹ä»¶
  repository_dispatch:
    types: [build-trigger]
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
      flutter_tag:
        description: 'Flutter app tag/commit'
        required: false
      core_tag:
        description: 'Core tag/commit'
        required: false

env:
  CORE_REPO: nursor/nursor-core2
  FLUTTER_REPO: nursor/nursor-flutter-app
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  detect-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      flutter_ref: ${{ steps.get_refs.outputs.flutter }}
      core_ref: ${{ steps.get_refs.outputs.core }}
    steps:
      - name: Get version from tag or input
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "push" ]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "version=${{ github.event.client_payload.version || github.event.client_payload.tag }}" >> $GITHUB_OUTPUT
          else
            echo "version=unknown" >> $GITHUB_OUTPUT
          fi
      
      - name: Determine refs
        id: get_refs
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            FLUTTER_REF="${{ github.event.inputs.flutter_tag }}"
            CORE_REF="${{ github.event.inputs.core_tag }}"
            if [ -z "$FLUTTER_REF" ]; then
              FLUTTER_REF="${VERSION}"
            fi
            if [ -z "$CORE_REF" ]; then
              CORE_REF="${VERSION}"
            fi
            echo "flutter=${FLUTTER_REF}" >> $GITHUB_OUTPUT
            echo "core=${CORE_REF}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            FLUTTER_REF="${{ github.event.client_payload.flutter_ref }}"
            CORE_REF="${{ github.event.client_payload.core_ref }}"
            if [ -z "$FLUTTER_REF" ]; then
              FLUTTER_REF="${VERSION}"
            fi
            if [ -z "$CORE_REF" ]; then
              CORE_REF="${VERSION}"
            fi
            echo "flutter=${FLUTTER_REF}" >> $GITHUB_OUTPUT
            echo "core=${CORE_REF}" >> $GITHUB_OUTPUT
          else
            echo "flutter=${VERSION}" >> $GITHUB_OUTPUT
            echo "core=${VERSION}" >> $GITHUB_OUTPUT
          fi

  build-macos:
    needs: detect-version
    strategy:
      matrix:
        arch: [amd64, arm64]
      fail-fast: false  # å…è®¸ä¸€ä¸ªå¤±è´¥æ—¶ä¸åœæ­¢å…¶ä»–æž„å»º
    runs-on: macos-14  # ä½¿ç”¨æœ€æ–°å¯ç”¨çš„macOS runner
    steps:
      - name: Checkout packaging repo
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'  # æœ€æ–°stableç‰ˆæœ¬
          channel: 'stable'
          architecture: ${{ matrix.arch == 'amd64' && 'x64' || 'arm64' }}
          cache: true
          cache-key: 'flutter-:os:-:channel:-:version:-:arch:-'
      
      - name: Download Flutter App
        uses: actions/checkout@v4
        with:
          repository: ${{ env.FLUTTER_REPO }}
          ref: ${{ needs.detect-version.outputs.flutter_ref }}
          path: flutter_app
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build Flutter App for macOS
        working-directory: ./flutter_app
        run: |
          flutter pub get
          # æ ¹æ®æž¶æž„é€‰æ‹©æž„å»ºç›®æ ‡
          if [ "${{ matrix.arch }}" = "amd64" ]; then
            flutter build macos --release --target-platform=darwin-x64
          else
            flutter build macos --release --target-platform=darwin-arm64
          fi
          # å¤åˆ¶Nursor.appåˆ°æž„å»ºç›®å½•
          cp -R build/macos/Build/Products/Release/Nursor.app ../macos/
      
      - name: Download nursor-core
        run: |
          CORE_REF="${{ needs.detect-version.outputs.core_ref }}"
          ARCH="${{ matrix.arch }}"
          mkdir -p macos
          
          # ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶
          CORE_URL="https://github.com/${{ env.CORE_REPO }}/releases/download/${CORE_REF}/core-darwin-${ARCH}"
          curl -L -o macos/nursor-core "${CORE_URL}"
          chmod +x macos/nursor-core
          
          # å°è¯•ä¸‹è½½å¹¶éªŒè¯SHA256 checksumï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          CHECKSUM_URL="https://github.com/${{ env.CORE_REPO }}/releases/download/${CORE_REF}/core-darwin-${ARCH}.sha256"
          if curl -fsSL "${CHECKSUM_URL}" > /tmp/checksum.sha256 2>/dev/null; then
            echo "Verifying SHA256 checksum..."
            (cd macos && sha256sum -c --quiet <(cat /tmp/checksum.sha256 | tr -d '\r\n' | awk '{print $1"  nursor-core"}')) || {
              echo "ERROR: SHA256 checksum verification failed"
              exit 1
            }
            echo "SHA256 checksum verified successfully"
          else
            echo "WARNING: SHA256 checksum file not found, skipping verification"
          fi
      
      - name: Prepare macOS build environment
        working-directory: ./macos
        run: |
          # ç¡®ä¿æ‰€æœ‰å¿…è¦çš„æ–‡ä»¶å­˜åœ¨
          echo "æ£€æŸ¥å¿…éœ€æ–‡ä»¶..."
          REQUIRED_FILES=(
            "nursor-core"
            "Nursor.app"
            "org.nursor.nursor-core.plist"
            "org.nursor.trustca.plist"
            "trust_ca_once.sh"
            "scripts/preinstall"
            "scripts/postinstall"
            "scripts/send_to_sentry.sh"
          )
          
          MISSING_FILES=()
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ] && [ ! -d "$file" ]; then
              MISSING_FILES+=("$file")
            fi
          done
          
          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo "ERROR: ä»¥ä¸‹å¿…éœ€æ–‡ä»¶æœªæ‰¾åˆ°:"
            printf '  - %s\n' "${MISSING_FILES[@]}"
            exit 1
          fi
          
          # æ£€æŸ¥ca.pemæ–‡ä»¶ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼Œè­¦å‘Šä½†ç»§ç»­ï¼‰
          if [ ! -f "ca.pem" ]; then
            echo "WARNING: ca.pem not found. If required, please ensure it exists in the macos directory."
          fi
          
          echo "æ‰€æœ‰å¿…éœ€æ–‡ä»¶æ£€æŸ¥é€šè¿‡ï¼"
      
      - name: Build macOS installer
        id: build_installer
        working-directory: ./macos
        run: |
          sudo ./build_installer.sh
          ls -lah output/
          echo "installer_built=true" >> $GITHUB_OUTPUT
      
      - name: Record build status
        if: always()
        run: |
          echo "Build status for ${{ matrix.arch }}: ${{ job.status }}" >> build_status.txt
      
      - name: Upload macOS installer
        uses: actions/upload-artifact@v4
        with:
          name: nursor-installer-macos-${{ matrix.arch }}
          path: macos/output/*.pkg
          retention-days: 30
      
      - name: Create GitHub Release (if tag exists)
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'repository_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          files: macos/output/*.pkg
          tag_name: ${{ needs.detect-version.outputs.version }}
          name: Release ${{ needs.detect-version.outputs.version }}
          body: |
            ## macOS Installer - ${{ matrix.arch }}
            
            Build triggered from: ${{ github.event_name }}
            Flutter ref: ${{ needs.detect-version.outputs.flutter_ref }}
            Core ref: ${{ needs.detect-version.outputs.core_ref }}
          draft: false
          prerelease: false

  build-windows:
    needs: detect-version
    runs-on: windows-latest
    steps:
      - name: Checkout packaging repo
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'
          channel: 'stable'
          cache: true
          cache-key: 'flutter-:os:-:channel:-:version:-:arch:-'
      
      - name: Download Flutter App
        uses: actions/checkout@v4
        with:
          repository: ${{ env.FLUTTER_REPO }}
          ref: ${{ needs.detect-version.outputs.flutter_ref }}
          path: flutter_app
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build Flutter App for Windows
        working-directory: ./flutter_app
        run: |
          flutter pub get
          flutter build windows --release
      
      - name: Download nursor-core for Windows
        run: |
          $CORE_REF="${{ needs.detect-version.outputs.core_ref }}"
          New-Item -ItemType Directory -Force -Path windows | Out-Null
          
          # ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶
          $CORE_URL = "https://github.com/${{ env.CORE_REPO }}/releases/download/$CORE_REF/core-windows-amd64"
          Invoke-WebRequest -Uri $CORE_URL -OutFile "windows/nursor-core-amd64.dll"
          
          # å°è¯•ä¸‹è½½å¹¶éªŒè¯SHA256 checksumï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          $CHECKSUM_URL = "https://github.com/${{ env.CORE_REPO }}/releases/download/$CORE_REF/core-windows-amd64.sha256"
          try {
            $checksumContent = Invoke-WebRequest -Uri $CHECKSUM_URL -UseBasicParsing | Select-Object -ExpandProperty Content
            $expectedHash = ($checksumContent -split '\s+')[0].Trim()
            $actualHash = (Get-FileHash -Path "windows/nursor-core-amd64.dll" -Algorithm SHA256).Hash.ToLower()
            if ($expectedHash.ToLower() -eq $actualHash) {
              Write-Host "SHA256 checksum verified successfully"
            } else {
              Write-Error "ERROR: SHA256 checksum verification failed. Expected: $expectedHash, Got: $actualHash"
              exit 1
            }
          } catch {
            Write-Host "WARNING: SHA256 checksum file not found, skipping verification"
          }
      
      - name: Setup Inno Setup
        run: |
          # ä¸‹è½½å¹¶å®‰è£… Inno Setup
          $innosetupVersion = "6.2.2"
          $innosetupUrl = "https://files.jrsoftware.org/is/6/innosetup-$innosetupVersion.exe"
          $installerPath = "$env:TEMP\innosetup-installer.exe"
          
          Write-Host "Downloading Inno Setup $innosetupVersion..."
          Invoke-WebRequest -Uri $innosetupUrl -OutFile $installerPath
          
          Write-Host "Installing Inno Setup..."
          Start-Process -FilePath $installerPath -ArgumentList "/SILENT", "/DIR=C:\Program Files (x86)\Inno Setup 6" -Wait
          
          Write-Host "Adding Inno Setup to PATH..."
          $env:PATH += ";C:\Program Files (x86)\Inno Setup 6"
          Add-Content -Path $env:GITHUB_ENV -Value "PATH=$env:PATH;C:\Program Files (x86)\Inno Setup 6"
          
          # éªŒè¯å®‰è£…
          if (Test-Path "C:\Program Files (x86)\Inno Setup 6\ISCC.exe") {
            Write-Host "Inno Setup installed successfully"
            & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" /?
          } else {
            Write-Error "Inno Setup installation failed"
            exit 1
          }
      
      - name: Prepare Windows build environment
        run: |
          # åˆ›å»ºæž„å»ºç›®å½•
          $buildDir = "windows_build"
          New-Item -ItemType Directory -Force -Path $buildDir | Out-Null
          
          # æ£€æŸ¥Flutteræž„å»ºäº§ç‰©
          $flutterBuildPath = "flutter_app\build\windows\x64\runner\Release"
          if (-not (Test-Path $flutterBuildPath)) {
            Write-Error "ERROR: Flutter build output not found at $flutterBuildPath"
            exit 1
          }
          
          Write-Host "Copying Flutter build artifacts..."
          # å¤åˆ¶Flutteræž„å»ºäº§ç‰©åˆ°æž„å»ºç›®å½•
          Copy-Item -Recurse -Force "$flutterBuildPath\*" "$buildDir\" -ErrorAction Stop
          
          Write-Host "Copying additional files from windows directory..."
          # æ£€æŸ¥å¹¶å¤åˆ¶nursor-coreæ–‡ä»¶
          if (-not (Test-Path "windows\nursor-core-amd64.dll")) {
            Write-Error "ERROR: nursor-core-amd64.dll not found in windows directory"
            exit 1
          }
          Copy-Item "windows\nursor-core-amd64.dll" "$buildDir\" -ErrorAction Stop
          
          # å¤åˆ¶wintun.dllï¼ˆå¦‚æžœå­˜åœ¨ï¼Œè¦†ç›–Flutteræž„å»ºä¸­çš„ç‰ˆæœ¬ï¼‰
          if (Test-Path "windows\wintun.dll") {
            Copy-Item "windows\wintun.dll" "$buildDir\" -Force -ErrorAction Stop
            Write-Host "Copied wintun.dll from windows directory"
          } else {
            Write-Host "WARNING: wintun.dll not found in windows directory, using Flutter build version"
          }
          
          # å¤åˆ¶ca.pemæ–‡ä»¶ï¼ˆè¯ä¹¦æ–‡ä»¶ï¼‰
          if (Test-Path "windows\ca.pem") {
            Copy-Item "windows\ca.pem" "$buildDir\" -Force -ErrorAction Stop
            Write-Host "Copied ca.pem from windows directory"
          } else {
            Write-Error "ERROR: ca.pem not found in windows directory"
            exit 1
          }
          
          # å¤åˆ¶logo.icoæ–‡ä»¶ï¼ˆå›¾æ ‡æ–‡ä»¶ï¼‰
          if (Test-Path "windows\logo.ico") {
            Copy-Item "windows\logo.ico" "$buildDir\" -Force -ErrorAction Stop
            Write-Host "Copied logo.ico from windows directory"
          } else {
            Write-Error "ERROR: logo.ico not found in windows directory"
            exit 1
          }
          
          Write-Host "Windows build environment prepared successfully"
          Write-Host "Build directory contents:"
          Get-ChildItem $buildDir | Select-Object Name, Length | Format-Table
      
      - name: Build Windows installer
        working-directory: ./windows_build
        run: |
          # éªŒè¯å¿…éœ€æ–‡ä»¶å­˜åœ¨å¹¶æ£€æµ‹å¯æ‰§è¡Œæ–‡ä»¶å
          Write-Host "Verifying required files in build directory..."
          
          # æ£€æŸ¥ä¸»å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¯èƒ½æ˜¯ nursor_app.exe æˆ–å…¶ä»–åç§°ï¼‰
          $exeFiles = Get-ChildItem -Filter "*.exe" | Where-Object { $_.Name -notlike "*runner*" -and $_.Name -notlike "*flutter*" }
          if ($exeFiles.Count -eq 0) {
            Write-Error "ERROR: No main executable file found (.exe)"
            Write-Host "Available .exe files:"
            Get-ChildItem -Filter "*.exe" | Select-Object Name | Format-Table
            exit 1
          }
          
          # ä½¿ç”¨æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ª .exe æ–‡ä»¶åï¼ˆé€šå¸¸æ˜¯ä¸»åº”ç”¨ï¼‰
          $mainExe = $exeFiles[0].Name
          Write-Host "âœ“ Found main executable: $mainExe"
          
          # éªŒè¯å…¶ä»–å¿…éœ€æ–‡ä»¶
          $requiredFiles = @("logo.ico", "ca.pem", "wintun.dll", "nursor-core-amd64.dll")
          foreach ($file in $requiredFiles) {
            if (-not (Test-Path $file)) {
              Write-Error "ERROR: Required file not found: $file"
              Write-Host "Available files:"
              Get-ChildItem | Select-Object Name | Format-Table
              exit 1
            }
            Write-Host "âœ“ Found: $file"
          }
          
          # æ£€æŸ¥ Flutter DLL æ–‡ä»¶ï¼ˆå¯é€‰ï¼Œå¦‚æžœä¸å­˜åœ¨ä¼šè­¦å‘Šï¼‰
          $flutterDlls = @("flutter_windows.dll", "nursorcore_plugin.dll", "screen_retriever_plugin.dll", "sentry.dll", "tray_manager_plugin.dll", "window_manager_plugin.dll")
          foreach ($dll in $flutterDlls) {
            if (Test-Path $dll) {
              Write-Host "âœ“ Found: $dll"
            } else {
              Write-Host "âš  WARNING: Flutter DLL not found: $dll (may be optional)"
            }
          }
          
          # å‡†å¤‡Inno Setupè„šæœ¬ï¼ˆå¤åˆ¶åˆ°æž„å»ºç›®å½•å¹¶æ›´æ–°è·¯å¾„ï¼‰
          $issFile = Get-Content "..\nursor_win_installer.iss" -Raw
          
          # æ›´æ–°ç‰ˆæœ¬å·ï¼ˆç§»é™¤ 'v' å‰ç¼€å¦‚æžœæœ‰ï¼‰
          $version = "${{ needs.detect-version.outputs.version }}"
          if ($version.StartsWith("v")) {
            $version = $version.Substring(1)
          }
          
          # æ›´æ–°Inno Setupè„šæœ¬ä¸­çš„è·¯å¾„ã€ç‰ˆæœ¬å’Œå¯æ‰§è¡Œæ–‡ä»¶å
          $issFile = $issFile -replace "#define MySourcePath.*", "#define MySourcePath `".`""
          $issFile = $issFile -replace "#define MyAppVersion.*", "#define MyAppVersion `"$version`""
          $issFile = $issFile -replace "#define MyIconPath.*", "#define MyIconPath `"logo.ico`""
          
          # æ›´æ–°å¯æ‰§è¡Œæ–‡ä»¶åï¼ˆå¦‚æžœä¸Žé»˜è®¤ä¸åŒï¼‰
          if ($mainExe -ne "nursor_app.exe") {
            Write-Host "Updating executable name from nursor_app.exe to $mainExe"
            $issFile = $issFile -replace "nursor_app\.exe", $mainExe
            $issFile = $issFile -replace "#define MyAppExeName.*", "#define MyAppExeName `"$mainExe`""
          }
          
          # ä¿å­˜æ›´æ–°åŽçš„è„šæœ¬åˆ°æž„å»ºç›®å½•
          $issFile | Set-Content "nursor_win_installer.iss"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          New-Item -ItemType Directory -Force -Path "..\output" | Out-Null
          
          # ä½¿ç”¨å®Œæ•´è·¯å¾„è°ƒç”¨ ISCCï¼ˆä»Žæž„å»ºç›®å½•ï¼‰
          $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (Test-Path $isccPath) {
            Write-Host "Building installer with Inno Setup..."
            & $isccPath "/O..\output" "nursor_win_installer.iss"
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Inno Setup compilation failed with exit code: $LASTEXITCODE"
              exit 1
            }
            Write-Host "Installer built successfully"
            Write-Host "Installer output:"
            Get-ChildItem "..\output" | Select-Object Name, Length | Format-Table
          } else {
            Write-Error "ISCC.exe not found at $isccPath"
            exit 1
          }
      
      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: nursor-installer-windows
          path: output/*.exe
          retention-days: 30
      
      - name: Create GitHub Release (if tag exists)
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'repository_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          files: output/*.exe
          tag_name: ${{ needs.detect-version.outputs.version }}
          name: Release ${{ needs.detect-version.outputs.version }}
          body: |
            ## Windows Installer
            
            Build triggered from: ${{ github.event_name }}
            Flutter ref: ${{ needs.detect-version.outputs.flutter_ref }}
            Core ref: ${{ needs.detect-version.outputs.core_ref }}
          draft: false
          prerelease: false

  build-linux:
    needs: detect-version
    strategy:
      matrix:
        arch: [amd64]
        # æ³¨æ„ï¼šarm64éœ€è¦self-hosted runnerï¼Œæš‚ä¸æ”¯æŒ
        # å¦‚éœ€arm64æ”¯æŒï¼Œè¯·é…ç½®self-hosted runneræˆ–ä½¿ç”¨cross-compilation
      fail-fast: false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout packaging repo
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'
          channel: 'stable'
          cache: true
          cache-key: 'flutter-:os:-:channel:-:version:-:arch:-'
      
      - name: Download Flutter App
        uses: actions/checkout@v4
        with:
          repository: ${{ env.FLUTTER_REPO }}
          ref: ${{ needs.detect-version.outputs.flutter_ref }}
          path: flutter_app
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libblkid1 \
            liblzma5 \
            libsecret-1-dev \
            desktop-file-utils \
            libappindicator3-dev \
            patchelf
      
      - name: Build Flutter App for Linux
        working-directory: ./flutter_app
        run: |
          flutter pub get
          # æ ¹æ®æž¶æž„é€‰æ‹©æž„å»ºç›®æ ‡ï¼ˆamd64ä½¿ç”¨x64ï¼Œarm64ä½¿ç”¨aarch64ï¼‰
          if [ "${{ matrix.arch }}" = "amd64" ]; then
            flutter build linux --release --target-platform=linux-x64
          else
            flutter build linux --release --target-platform=linux-arm64
          fi
      
      - name: Download nursor-core for Linux
        run: |
          CORE_REF="${{ needs.detect-version.outputs.core_ref }}"
          ARCH="${{ matrix.arch }}"
          mkdir -p linux
          
          # ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶
          CORE_URL="https://github.com/${{ env.CORE_REPO }}/releases/download/${CORE_REF}/core-linux-${ARCH}"
          curl -L -o linux/nursor-core "${CORE_URL}"
          chmod +x linux/nursor-core
          
          # å°è¯•ä¸‹è½½å¹¶éªŒè¯SHA256 checksumï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          CHECKSUM_URL="https://github.com/${{ env.CORE_REPO }}/releases/download/${CORE_REF}/core-linux-${ARCH}.sha256"
          if curl -fsSL "${CHECKSUM_URL}" > /tmp/checksum.sha256 2>/dev/null; then
            echo "Verifying SHA256 checksum..."
            (cd linux && sha256sum -c --quiet <(cat /tmp/checksum.sha256 | tr -d '\r\n' | awk '{print $1"  nursor-core"}')) || {
              echo "ERROR: SHA256 checksum verification failed"
              exit 1
            }
            echo "SHA256 checksum verified successfully"
          else
            echo "WARNING: SHA256 checksum file not found, skipping verification"
          fi
      
      - name: Package Linux installer
        id: package_installer
        run: |
          ARCH="${{ matrix.arch }}"
          PACKAGE_VERSION="${{ needs.detect-version.outputs.version }}"
          
          # åˆ›å»ºAppImageæˆ–debåŒ…çš„ç»“æž„
          mkdir -p linux_appimage/usr/bin
          mkdir -p linux_appimage/usr/share/applications
          mkdir -p linux_appimage/usr/share/icons
          
          # æ ¹æ®æž¶æž„é€‰æ‹©æ­£ç¡®çš„æž„å»ºè¾“å‡ºè·¯å¾„
          if [ "$ARCH" = "amd64" ]; then
            BUILD_PATH="x64"
          else
            BUILD_PATH="arm64"
          fi
          
          # å¤åˆ¶Flutteræž„å»ºäº§ç‰©
          if [ -d "flutter_app/build/linux/${BUILD_PATH}/release/bundle" ]; then
            cp -R flutter_app/build/linux/${BUILD_PATH}/release/bundle/* linux_appimage/
          else
            echo "ERROR: Flutter build output not found at flutter_app/build/linux/${BUILD_PATH}/release/bundle"
            exit 1
          fi
          cp linux/nursor-core linux_appimage/nursor-core
          
          # åˆ›å»º.desktopæ–‡ä»¶
          cat > linux_appimage/usr/share/applications/nursor.desktop <<EOF
          [Desktop Entry]
          Version=1.0
          Type=Application
          Name=Nursor
          Exec=nursor
          Icon=nursor
          Categories=Utility;
          EOF
          
          # åˆ›å»ºtar.gzåŒ…ï¼ˆç®€åŒ–ç‰ˆï¼‰
          tar -czf output/nursor-linux-${ARCH}-${PACKAGE_VERSION}.tar.gz -C linux_appimage .
          echo "package_created=true" >> $GITHUB_OUTPUT
      
      - name: Record build status
        if: always()
        run: |
          echo "Build status for ${{ matrix.arch }}: ${{ job.status }}" >> build_status.txt
      
      - name: Upload Linux installer
        uses: actions/upload-artifact@v4
        with:
          name: nursor-installer-linux-${{ matrix.arch }}
          path: output/*.tar.gz
          retention-days: 30
      
      - name: Create GitHub Release (if tag exists)
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'repository_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          files: output/*.tar.gz
          tag_name: ${{ needs.detect-version.outputs.version }}
          name: Release ${{ needs.detect-version.outputs.version }}
          body: |
            ## Linux Installer - ${{ matrix.arch }}
            
            Build triggered from: ${{ github.event_name }}
            Flutter ref: ${{ needs.detect-version.outputs.flutter_ref }}
            Core ref: ${{ needs.detect-version.outputs.core_ref }}
          draft: false
          prerelease: false

  notify-completion:
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## ðŸ“¦ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### macOS" >> $GITHUB_STEP_SUMMARY
          echo "- amd64: ${{ needs.build-macos.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- arm64: ${{ needs.build-macos.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Windows" >> $GITHUB_STEP_SUMMARY
          echo "- amd64: ${{ needs.build-windows.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Linux" >> $GITHUB_STEP_SUMMARY
          echo "- amd64: ${{ needs.build-linux.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- arm64: âš ï¸ Not supported (requires self-hosted runner)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Status:** ${{ needs.build-macos.result == 'success' && needs.build-windows.result == 'success' && needs.build-linux.result == 'success' && 'âœ… All builds succeeded' || 'âŒ Some builds failed' }}" >> $GITHUB_STEP_SUMMARY

