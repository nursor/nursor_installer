name: Build All Platforms

on:
  # ç›‘å¬å½“å‰ä»“åº“çš„tagäº‹ä»¶
  push:
    tags:
      - 'v*'
  # ç›‘å¬å…¶ä»–ä»“åº“é€šè¿‡repository_dispatchè§¦å‘çš„äº‹ä»¶
  repository_dispatch:
    types: [build-trigger]
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
      flutter_tag:
        description: 'Flutter app tag/commit'
        required: false
      core_tag:
        description: 'Core tag/commit'
        required: false

env:
  CORE_REPO: nursor/nursor-core2
  FLUTTER_REPO: nursor/nursor-flutter-app
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  detect-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      flutter_ref: ${{ steps.get_refs.outputs.flutter }}
      core_ref: ${{ steps.get_refs.outputs.core }}
    steps:
      - name: Get version from tag or input
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "push" ]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            # å°è¯•èŽ·å– version æˆ– tagï¼Œå¦‚æžœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
            VERSION_VAL="${{ github.event.client_payload.version }}"
            if [ -z "$VERSION_VAL" ]; then
              VERSION_VAL="${{ github.event.client_payload.tag }}"
            fi
            if [ -z "$VERSION_VAL" ]; then
              VERSION_VAL="latest"
            fi
            echo "version=${VERSION_VAL}" >> $GITHUB_OUTPUT
          else
            echo "version=unknown" >> $GITHUB_OUTPUT
          fi
          echo "Detected version: $(cat $GITHUB_OUTPUT | grep version= | cut -d= -f2)"
      
      - name: Determine refs
        id: get_refs
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          echo "Processing refs for version: ${VERSION}"
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            FLUTTER_REF="${{ github.event.inputs.flutter_tag }}"
            CORE_REF="${{ github.event.inputs.core_tag }}"
            if [ -z "$FLUTTER_REF" ]; then
              FLUTTER_REF="${VERSION}"
            fi
            if [ -z "$CORE_REF" ]; then
              CORE_REF="${VERSION}"
            fi
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            FLUTTER_REF="${{ github.event.client_payload.flutter_ref }}"
            CORE_REF="${{ github.event.client_payload.core_ref }}"
            if [ -z "$FLUTTER_REF" ]; then
              FLUTTER_REF="${VERSION}"
            fi
            if [ -z "$CORE_REF" ]; then
              CORE_REF="${VERSION}"
            fi
          elif [ "${{ github.event_name }}" = "push" ]; then
            # å½“æœ¬ä»“åº“æ‰“ tag è§¦å‘æ—¶ï¼Œä»Žå¤–éƒ¨ä¸¤ä¸ªä»“åº“èŽ·å–æœ€æ–°çš„ tag
            API_TOKEN="${{ secrets.PACKAGING_REPO_TOKEN }}"
            if [ -z "$API_TOKEN" ]; then
              API_TOKEN="${{ secrets.GITHUB_TOKEN }}"
            fi

            get_latest_tag() {
              local repo="$1"
              # ä¼˜å…ˆå°è¯• releases/latestï¼ˆè‹¥æ²¡æœ‰å‘å¸ƒä¼šè¿”å›žéž 200ï¼‰ï¼Œå¤±è´¥åˆ™å›žé€€åˆ° /tags
              local latest_release
              latest_release=$(curl -s -H "Authorization: token ${API_TOKEN}" "https://api.github.com/repos/${repo}/releases/latest" | grep -m1 '"tag_name"' | sed 's/.*"tag_name" *: *"\([^"]*\)".*/\1/')
              if [ -n "$latest_release" ]; then
                echo "$latest_release"
                return 0
              fi
              # å›žé€€ï¼šè¯»å– tags åˆ—è¡¨çš„ç¬¬ä¸€ä¸ª name
              curl -s -H "Authorization: token ${API_TOKEN}" "https://api.github.com/repos/${repo}/tags?per_page=1" \
                | grep -m1 '"name"' \
                | sed 's/.*"name" *: *"\([^"]*\)".*/\1/'
            }

            FLUTTER_REF=$(get_latest_tag "${{ env.FLUTTER_REPO }}")
            CORE_REF=$(get_latest_tag "${{ env.CORE_REPO }}")

            # å…œåº•å¤„ç†ï¼šå¦‚æžœèŽ·å–å¤±è´¥ï¼Œä½¿ç”¨å½“å‰ç‰ˆæœ¬å·
            if [ -z "$FLUTTER_REF" ]; then
              FLUTTER_REF="${VERSION}"
            fi
            if [ -z "$CORE_REF" ]; then
              CORE_REF="${VERSION}"
            fi
          else
            FLUTTER_REF="${VERSION}"
            CORE_REF="${VERSION}"
          fi
          
          # æ¸…ç† refï¼šç§»é™¤ä»»ä½•å‰ç¼€ï¼Œç¡®ä¿æ ¼å¼æ­£ç¡®
          # actions/checkout å¯ä»¥ç›´æŽ¥ä½¿ç”¨ tag åç§°ï¼ˆå¦‚ v1.0.0ï¼‰ï¼Œä¸éœ€è¦ refs/tags/ å‰ç¼€
          FLUTTER_REF=$(echo "$FLUTTER_REF" | sed 's|^refs/tags/||' | sed 's|^refs/heads/||')
          CORE_REF=$(echo "$CORE_REF" | sed 's|^refs/tags/||' | sed 's|^refs/heads/||')
          
          echo "Final Flutter ref: ${FLUTTER_REF}"
          echo "Final Core ref: ${CORE_REF}"
          
          echo "flutter=${FLUTTER_REF}" >> $GITHUB_OUTPUT
          echo "core=${CORE_REF}" >> $GITHUB_OUTPUT

  build-macos:
    needs: detect-version
    uses: ./.github/workflows/build-macos.yml
    with:
      version: ${{ needs.detect-version.outputs.version }}
      flutter_ref: ${{ needs.detect-version.outputs.flutter_ref }}
      core_ref: ${{ needs.detect-version.outputs.core_ref }}
    secrets: inherit

  build-windows:
    needs: detect-version
    uses: ./.github/workflows/build-windows.yml
    with:
      version: ${{ needs.detect-version.outputs.version }}
      flutter_ref: ${{ needs.detect-version.outputs.flutter_ref }}
      core_ref: ${{ needs.detect-version.outputs.core_ref }}
    secrets: inherit

  build-linux:
    needs: detect-version
    uses: ./.github/workflows/build-linux.yml
    with:
      version: ${{ needs.detect-version.outputs.version }}
      flutter_ref: ${{ needs.detect-version.outputs.flutter_ref }}
      core_ref: ${{ needs.detect-version.outputs.core_ref }}
    secrets: inherit

  notify-completion:
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## ðŸ“¦ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### macOS" >> $GITHUB_STEP_SUMMARY
          echo "- amd64: ${{ needs.build-macos.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- arm64: ${{ needs.build-macos.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Windows" >> $GITHUB_STEP_SUMMARY
          echo "- amd64: ${{ needs.build-windows.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Linux" >> $GITHUB_STEP_SUMMARY
          echo "- amd64: ${{ needs.build-linux.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- arm64: âš ï¸ Not supported (requires self-hosted runner)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Status:** ${{ needs.build-macos.result == 'success' && needs.build-windows.result == 'success' && needs.build-linux.result == 'success' && 'âœ… All builds succeeded' || 'âŒ Some builds failed' }}" >> $GITHUB_STEP_SUMMARY
