name: Build All Platforms

on:
  # ç›‘å¬å½“å‰ä»“åº“çš„tagäº‹ä»¶
  push:
    tags:
      - 'v*'
  # ç›‘å¬å…¶ä»–ä»“åº“é€šè¿‡repository_dispatchè§¦å‘çš„äº‹ä»¶
  repository_dispatch:
    types: [build-trigger]
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
      flutter_tag:
        description: 'Flutter app tag/commit'
        required: false
      core_tag:
        description: 'Core tag/commit'
        required: false

env:
  CORE_REPO: nursor/nursor-core2
  FLUTTER_REPO: nursor/nursor-flutter-app
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  detect-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      flutter_ref: ${{ steps.get_refs.outputs.flutter }}
      core_ref: ${{ steps.get_refs.outputs.core }}
    steps:
      - name: Get version from tag or input
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "push" ]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            # å°è¯•èŽ·å– version æˆ– tagï¼Œå¦‚æžœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
            VERSION_VAL="${{ github.event.client_payload.version }}"
            if [ -z "$VERSION_VAL" ]; then
              VERSION_VAL="${{ github.event.client_payload.tag }}"
            fi
            if [ -z "$VERSION_VAL" ]; then
              VERSION_VAL="latest"
            fi
            echo "version=${VERSION_VAL}" >> $GITHUB_OUTPUT
          else
            echo "version=unknown" >> $GITHUB_OUTPUT
          fi
          echo "Detected version: $(cat $GITHUB_OUTPUT | grep version= | cut -d= -f2)"
      
      - name: Determine refs
        id: get_refs
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          echo "Processing refs for version: ${VERSION}"
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            FLUTTER_REF="${{ github.event.inputs.flutter_tag }}"
            CORE_REF="${{ github.event.inputs.core_tag }}"
            if [ -z "$FLUTTER_REF" ]; then
              FLUTTER_REF="${VERSION}"
            fi
            if [ -z "$CORE_REF" ]; then
              CORE_REF="${VERSION}"
            fi
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            FLUTTER_REF="${{ github.event.client_payload.flutter_ref }}"
            CORE_REF="${{ github.event.client_payload.core_ref }}"
            if [ -z "$FLUTTER_REF" ]; then
              FLUTTER_REF="${VERSION}"
            fi
            if [ -z "$CORE_REF" ]; then
              CORE_REF="${VERSION}"
            fi
          else
            FLUTTER_REF="${VERSION}"
            CORE_REF="${VERSION}"
          fi
          
          # æ¸…ç† refï¼šç§»é™¤ä»»ä½•å‰ç¼€ï¼Œç¡®ä¿æ ¼å¼æ­£ç¡®
          # actions/checkout å¯ä»¥ç›´æŽ¥ä½¿ç”¨ tag åç§°ï¼ˆå¦‚ v1.0.0ï¼‰ï¼Œä¸éœ€è¦ refs/tags/ å‰ç¼€
          FLUTTER_REF=$(echo "$FLUTTER_REF" | sed 's|^refs/tags/||' | sed 's|^refs/heads/||')
          CORE_REF=$(echo "$CORE_REF" | sed 's|^refs/tags/||' | sed 's|^refs/heads/||')
          
          echo "Final Flutter ref: ${FLUTTER_REF}"
          echo "Final Core ref: ${CORE_REF}"
          
          echo "flutter=${FLUTTER_REF}" >> $GITHUB_OUTPUT
          echo "core=${CORE_REF}" >> $GITHUB_OUTPUT

  build-macos:
    needs: detect-version
    strategy:
      matrix:
        arch: [amd64, arm64]
      fail-fast: false  # å…è®¸ä¸€ä¸ªå¤±è´¥æ—¶ä¸åœæ­¢å…¶ä»–æž„å»º
    runs-on: macos-14  # GitHub Actions ä¼šæ ¹æ®å¯ç”¨æ€§è‡ªåŠ¨é€‰æ‹©æž¶æž„
    steps:
      - name: Checkout packaging repo
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'  # ä½¿ç”¨ç¨³å®šé€šé“çš„æœ€æ–°ç‰ˆæœ¬ï¼ˆæ”¯æŒ Dart 3.8.1+ï¼‰
          architecture: ${{ matrix.arch == 'amd64' && 'x64' || 'arm64' }}
          cache: true
          cache-key: 'flutter-:os:-:channel:-:version:-:arch:-'
      
      - name: Download Flutter App
        uses: actions/checkout@v4
        with:
          repository: ${{ env.FLUTTER_REPO }}
          ref: ${{ needs.detect-version.outputs.flutter_ref }}
          path: flutter_app
          token: ${{ secrets.PACKAGING_REPO_TOKEN }}
          fetch-depth: 0
      
      - name: Build Flutter App for macOS
        working-directory: ./flutter_app
        run: |
          flutter pub get
          # Flutter ä¼šæ ¹æ®è¿è¡Œå™¨çš„æž¶æž„è‡ªåŠ¨æž„å»ºå¯¹åº”æž¶æž„çš„ç‰ˆæœ¬
          flutter build macos --release
          # å¤åˆ¶Nursor.appåˆ°æž„å»ºç›®å½•
          cp -R build/macos/Build/Products/Release/Nursor.app ../macos/
      
      - name: Download nursor-core
        run: |
          CORE_REF="${{ needs.detect-version.outputs.core_ref }}"
          ARCH="${{ matrix.arch }}"
          TOKEN="${{ secrets.PACKAGING_REPO_TOKEN }}"
          mkdir -p macos
          
          # ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆéœ€è¦è®¤è¯ï¼Œå› ä¸º release assets æ˜¯ç§æœ‰çš„ï¼‰
          CORE_URL="https://github.com/${{ env.CORE_REPO }}/releases/download/${CORE_REF}/core-darwin-${ARCH}"
          echo "Downloading nursor-core from: $CORE_URL"
          
          curl -L \
            -H "Authorization: token ${TOKEN}" \
            -H "Accept: application/octet-stream" \
            -o macos/nursor-core \
            "${CORE_URL}"
          
          if [ ! -f "macos/nursor-core" ] || [ ! -s "macos/nursor-core" ]; then
            echo "ERROR: Failed to download nursor-core or file is empty"
            exit 1
          fi
          
          chmod +x macos/nursor-core
          echo "âœ“ nursor-core downloaded successfully"
          
          # å°è¯•ä¸‹è½½å¹¶éªŒè¯SHA256 checksumï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          CHECKSUM_URL="https://github.com/${{ env.CORE_REPO }}/releases/download/${CORE_REF}/core-darwin-${ARCH}.sha256"
          if curl -fsSL \
            -H "Authorization: token ${TOKEN}" \
            -H "Accept: application/octet-stream" \
            "${CHECKSUM_URL}" > /tmp/checksum.sha256 2>/dev/null; then
            echo "Verifying SHA256 checksum..."
            (cd macos && echo "$(cat /tmp/checksum.sha256 | awk '{print $1}')  nursor-core" | shasum -a 256 -c) || {
              echo "ERROR: SHA256 checksum verification failed"
              exit 1
            }
            echo "âœ“ SHA256 checksum verified successfully"
          else
            echo "âš  WARNING: SHA256 checksum file not found, skipping verification"
          fi
      
      - name: Prepare macOS build environment
        working-directory: ./macos
        run: |
          # ç¡®ä¿æ‰€æœ‰å¿…è¦çš„æ–‡ä»¶å­˜åœ¨
          echo "æ£€æŸ¥å¿…éœ€æ–‡ä»¶..."
          REQUIRED_FILES=(
            "build_installer.sh"
            "nursor-core"
            "Nursor.app"
            "org.nursor.nursor-core.plist"
            "org.nursor.trustca.plist"
            "trust_ca_once.sh"
            "scripts/preinstall"
            "scripts/postinstall"
            "scripts/send_to_sentry.sh"
          )
          
          MISSING_FILES=()
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ] && [ ! -d "$file" ]; then
              MISSING_FILES+=("$file")
            fi
          done
          
          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo "ERROR: ä»¥ä¸‹å¿…éœ€æ–‡ä»¶æœªæ‰¾åˆ°:"
            printf '  - %s\n' "${MISSING_FILES[@]}"
            echo ""
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -lah
            exit 1
          fi
          
          # ç¡®ä¿ build_installer.sh æœ‰æ‰§è¡Œæƒé™
          if [ -f "build_installer.sh" ]; then
            chmod +x build_installer.sh
            echo "âœ“ build_installer.sh å·²è®¾ç½®æ‰§è¡Œæƒé™"
            ls -l build_installer.sh
          else
            echo "ERROR: build_installer.sh ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ£€æŸ¥ca.pemæ–‡ä»¶ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼Œè­¦å‘Šä½†ç»§ç»­ï¼‰
          if [ ! -f "ca.pem" ]; then
            echo "WARNING: ca.pem not found. If required, please ensure it exists in the macos directory."
          fi
          
          echo "æ‰€æœ‰å¿…éœ€æ–‡ä»¶æ£€æŸ¥é€šè¿‡ï¼"
      
      - name: Build macOS installer
        id: build_installer
        working-directory: ./macos
        run: |
          # èŽ·å–å½“å‰ç»å¯¹è·¯å¾„
          MACOS_DIR="$(pwd)"
          SCRIPT_PATH="${MACOS_DIR}/build_installer.sh"
          
          echo "Current directory: $MACOS_DIR"
          echo "Script path: $SCRIPT_PATH"
          
          # å†æ¬¡ç¡®è®¤è„šæœ¬å­˜åœ¨ä¸”æœ‰æ‰§è¡Œæƒé™
          if [ ! -f "$SCRIPT_PATH" ]; then
            echo "ERROR: build_installer.sh not found at $SCRIPT_PATH"
            echo "Current directory: $MACOS_DIR"
            echo "Directory contents:"
            ls -lah
            exit 1
          fi
          
          # ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
          if [ ! -x "$SCRIPT_PATH" ]; then
            echo "Setting execute permission on build_installer.sh"
            chmod +x "$SCRIPT_PATH"
          fi
          
          # æ˜¾ç¤ºè„šæœ¬æƒé™ä¿¡æ¯
          echo "Script permissions:"
          ls -l "$SCRIPT_PATH"
          
          # éªŒè¯è„šæœ¬å¯æ‰§è¡Œ
          if [ ! -x "$SCRIPT_PATH" ]; then
            echo "ERROR: build_installer.sh is not executable"
            exit 1
          fi
          
          # ä½¿ç”¨ç»å¯¹è·¯å¾„æ‰§è¡Œè„šæœ¬ï¼ˆsudo å¯èƒ½æ— æ³•æ‰¾åˆ°ç›¸å¯¹è·¯å¾„ï¼‰
          echo "Executing build_installer.sh with absolute path..."
          sudo "$SCRIPT_PATH"
          
          # æ£€æŸ¥è„šæœ¬æ‰§è¡Œç»“æžœ
          if [ $? -ne 0 ]; then
            echo "ERROR: build_installer.sh failed with exit code $?"
            exit 1
          fi
          
          # æ£€æŸ¥è¾“å‡ºç›®å½•
          if [ ! -d "${MACOS_DIR}/output" ]; then
            echo "ERROR: output directory not created at ${MACOS_DIR}/output"
            exit 1
          fi
          
          echo "âœ“ Installer built successfully"
          ls -lah "${MACOS_DIR}/output/"
          echo "installer_built=true" >> $GITHUB_OUTPUT
      
      - name: Record build status
        if: always()
        run: |
          echo "Build status for ${{ matrix.arch }}: ${{ job.status }}" >> build_status.txt
      
      - name: Upload macOS installer
        uses: actions/upload-artifact@v4
        with:
          name: nursor-installer-macos-${{ matrix.arch }}
          path: macos/output/*.pkg
          retention-days: 30
      
      - name: Create GitHub Release (if tag exists)
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'repository_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          files: macos/output/*.pkg
          tag_name: ${{ needs.detect-version.outputs.version }}
          name: Release ${{ needs.detect-version.outputs.version }}
          body: |
            ## macOS Installer - ${{ matrix.arch }}
            
            Build triggered from: ${{ github.event_name }}
            Flutter ref: ${{ needs.detect-version.outputs.flutter_ref }}
            Core ref: ${{ needs.detect-version.outputs.core_ref }}
          draft: false
          prerelease: false

  build-windows:
    needs: detect-version
    runs-on: windows-latest
    steps:
      - name: Checkout packaging repo
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'  # ä½¿ç”¨ç¨³å®šé€šé“çš„æœ€æ–°ç‰ˆæœ¬ï¼ˆæ”¯æŒ Dart 3.8.1+ï¼‰
          cache: true
          cache-key: 'flutter-:os:-:channel:-:version:-:arch:-'
      
      - name: Download Flutter App
        uses: actions/checkout@v4
        with:
          repository: ${{ env.FLUTTER_REPO }}
          ref: ${{ needs.detect-version.outputs.flutter_ref }}
          path: flutter_app
          token: ${{ secrets.PACKAGING_REPO_TOKEN }}
          fetch-depth: 0
      
      - name: Build Flutter App for Windows
        working-directory: ./flutter_app
        run: |
          flutter pub get
          flutter build windows --release
      
      - name: Download nursor-core for Windows
        run: |
          $CORE_REF="${{ needs.detect-version.outputs.core_ref }}"
          $CORE_REPO="${{ env.CORE_REPO }}"
          $TOKEN="${{ secrets.PACKAGING_REPO_TOKEN }}"
          
          New-Item -ItemType Directory -Force -Path windows | Out-Null
          
            # æž„å»ºä¸‹è½½ URLï¼ˆWindows ç‰ˆæœ¬çš„æ–‡ä»¶åæ˜¯ nursor.dllï¼‰
            # ç›´æŽ¥ä¸‹è½½åˆ°ç›®æ ‡æ–‡ä»¶åï¼Œé¿å…é‡å‘½åæ­¥éª¤
            $OUTPUT_FILE = "windows/nursor-core-amd64.dll"
            
            Write-Host "Downloading nursor-core..."
            Write-Host "Target file: $OUTPUT_FILE"
          
          # éªŒè¯ token æ˜¯å¦è®¾ç½®ï¼ˆä¸æ˜¾ç¤ºå®Œæ•´ tokenï¼‰
          if ([string]::IsNullOrEmpty($TOKEN)) {
            Write-Error "ERROR: PACKAGING_REPO_TOKEN is not set or empty"
            exit 1
          }
          Write-Host "Token is set (length: $($TOKEN.Length) characters)"
          
          # å¯¹äºŽç§æœ‰ä»“åº“çš„ release assetsï¼Œéœ€è¦ä½¿ç”¨ GitHub API ä¸‹è½½
          # æ­¥éª¤1ï¼šä½¿ç”¨ API èŽ·å– asset ID
          $apiUrl = "https://api.github.com/repos/$CORE_REPO/releases/tags/$CORE_REF"
          $apiHeaders = @{
            "Authorization" = "Bearer $TOKEN"
            "Accept" = "application/vnd.github.v3+json"
            "User-Agent" = "GitHub-Actions"
          }
          
          # ä½¿ç”¨ API èŽ·å– release ä¿¡æ¯
          Write-Host "Step 1: Fetching release asset information via GitHub API..."
          Write-Host "Calling GitHub API: $apiUrl"
          
          try {
            $releaseResponse = Invoke-RestMethod -Uri $apiUrl -Headers $apiHeaders -Method Get
            Write-Host "âœ“ Release found: $($releaseResponse.name)"
            Write-Host "Release ID: $($releaseResponse.id)"
            Write-Host "Assets count: $($releaseResponse.assets.Count)"
          } catch {
            Write-Host "=========================================="
            Write-Host "API ERROR DETAILS"
            Write-Host "=========================================="
            Write-Error "ERROR: Failed to fetch release information from GitHub API"
            Write-Host "API URL: $apiUrl"
            Write-Host "Error Type: $($_.Exception.GetType().FullName)"
            Write-Host "Error Message: $($_.Exception.Message)"
            
            # æ£€æŸ¥ HTTP çŠ¶æ€ç 
            if ($_.Exception -is [System.Net.WebException]) {
              $webException = $_.Exception
              if ($webException.Response) {
                $statusCode = [int]$webException.Response.StatusCode
                Write-Host "HTTP Status Code: $statusCode"
                
                if ($statusCode -eq 404) {
                  Write-Host "Release tag not found: $CORE_REF"
                  Write-Host "Please check if the release tag exists in repository: $CORE_REPO"
                } elseif ($statusCode -eq 401 -or $statusCode -eq 403) {
                  Write-Host "Authentication failed. Token may not have access to repository: $CORE_REPO"
                  Write-Host "Please verify PACKAGING_REPO_TOKEN has 'repo' scope and access to this repository"
                }
              }
            }
            Write-Host "=========================================="
            exit 1
          }
          
          # æŸ¥æ‰¾åä¸º nursor.dll çš„ asset
          $asset = $releaseResponse.assets | Where-Object { $_.name -eq "nursor.dll" }
          
          if (-not $asset) {
            Write-Error "ERROR: Asset 'nursor.dll' not found in release $CORE_REF"
            Write-Host "Available assets in this release:"
            if ($releaseResponse.assets.Count -eq 0) {
              Write-Host "  (no assets found)"
            } else {
              $releaseResponse.assets | ForEach-Object { Write-Host "  - $($_.name) (ID: $($_.id))" }
            }
            exit 1
          }
          
          Write-Host "âœ“ Found asset: $($asset.name) (ID: $($asset.id), Size: $($asset.size) bytes)"
          
          # å¯¹äºŽç§æœ‰ä»“åº“ï¼Œå¿…é¡»ä½¿ç”¨ API ä¸‹è½½ç«¯ç‚¹ï¼Œä¸èƒ½ç›´æŽ¥ä½¿ç”¨ browser_download_url
          $assetUrl = "https://api.github.com/repos/$CORE_REPO/releases/assets/$($asset.id)"
          Write-Host "Using API download endpoint: $assetUrl"
          
          # æ­¥éª¤2ï¼šä½¿ç”¨ API ä¸‹è½½ assetï¼ˆéœ€è¦è®¤è¯ï¼‰
          Write-Host "Step 2: Downloading asset from: $assetUrl"
          $downloadHeaders = @{
            "Authorization" = "Bearer $TOKEN"
            "Accept" = "application/octet-stream"
            "User-Agent" = "GitHub-Actions"
          }
          
          Write-Host "Using authentication headers: Authorization=Bearer ***, Accept=application/octet-stream"
          
          # ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶
          try {
            # ç›´æŽ¥ä¸‹è½½åˆ°ç›®æ ‡æ–‡ä»¶å
            $response = Invoke-WebRequest -Uri $assetUrl -Headers $downloadHeaders -OutFile $OUTPUT_FILE -UseBasicParsing
            
            Write-Host "HTTP Status Code: $($response.StatusCode)"
            Write-Host "Download completed successfully"
          } catch {
            Write-Host "=========================================="
            Write-Host "DOWNLOAD ERROR DETAILS"
            Write-Host "=========================================="
            Write-Error "ERROR: Failed to download nursor-core asset"
            Write-Host "Asset URL: $assetUrl"
            Write-Host "Error Type: $($_.Exception.GetType().FullName)"
            Write-Host "Error Message: $($_.Exception.Message)"
            
            # æ£€æŸ¥ HTTP çŠ¶æ€ç 
            if ($_.Exception -is [System.Net.WebException]) {
              $webException = $_.Exception
              if ($webException.Response) {
                $statusCode = [int]$webException.Response.StatusCode
                Write-Host "HTTP Status Code: $statusCode"
                
                if ($statusCode -eq 404) {
                  Write-Host "Asset not found. Please check if the asset exists in the release."
                } elseif ($statusCode -eq 401 -or $statusCode -eq 403) {
                  Write-Host "Authentication failed. Token may not have access to download the asset."
                  Write-Host "Please verify PACKAGING_REPO_TOKEN has 'repo' scope and access to this repository"
                }
              }
            }
            Write-Host "=========================================="
            exit 1
          }
          
          # ç®€å•çš„æ–‡ä»¶éªŒè¯ï¼šåªæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©º
          if (-not (Test-Path $OUTPUT_FILE)) {
            Write-Error "ERROR: File not found after download: $OUTPUT_FILE"
            exit 1
          }
          
          $fileSize = (Get-Item $OUTPUT_FILE).Length
          Write-Host "Downloaded file size: $fileSize bytes"
          
          if ($fileSize -eq 0) {
            Write-Error "ERROR: Downloaded file is empty"
            exit 1
          }
          
          Write-Host "âœ“ File downloaded successfully"
          
          # å°è¯•ä¸‹è½½å¹¶éªŒè¯SHA256 checksumï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          # å¯¹äºŽç§æœ‰ä»“åº“ï¼Œä¹Ÿéœ€è¦ä½¿ç”¨ API ä¸‹è½½ checksum
          try {
            Write-Host "Checking for SHA256 checksum..."
            # æŸ¥æ‰¾ checksum asset
            $checksumAsset = $releaseResponse.assets | Where-Object { $_.name -eq "nursor.dll.sha256" }
            
            if ($checksumAsset) {
              Write-Host "âœ“ Found checksum asset: $($checksumAsset.name)"
              $checksumAssetUrl = "https://api.github.com/repos/$CORE_REPO/releases/assets/$($checksumAsset.id)"
              
              $checksumHeaders = @{
                "Authorization" = "Bearer $TOKEN"
                "Accept" = "application/octet-stream"
              }
              $checksumResponse = Invoke-WebRequest -Uri $checksumAssetUrl -Headers $checksumHeaders -UseBasicParsing -ErrorAction Stop
              $checksumContent = $checksumResponse.Content.Trim()
              $expectedHash = ($checksumContent -split '\s+')[0].Trim()
              
              Write-Host "Expected SHA256: $expectedHash"
              
              $actualHash = (Get-FileHash -Path $OUTPUT_FILE -Algorithm SHA256).Hash.ToLower()
              Write-Host "Actual SHA256: $actualHash"
              
              if ($expectedHash.ToLower() -eq $actualHash) {
                Write-Host "âœ“ SHA256 checksum verified successfully"
              } else {
                Write-Error "ERROR: SHA256 checksum verification failed"
                Write-Error "Expected: $expectedHash"
                Write-Error "Got: $actualHash"
                exit 1
              }
            } else {
              Write-Host "âš  WARNING: SHA256 checksum file not found in release, skipping verification"
            }
          } catch {
            Write-Host "âš  WARNING: SHA256 checksum verification failed or not available, skipping"
            Write-Host "  Error: $($_.Exception.Message)"
          }
      
      - name: Setup Inno Setup
        run: |
          # ä¸‹è½½å¹¶å®‰è£… Inno Setup
          $innosetupVersion = "6.2.2"
          $innosetupUrl = "https://files.jrsoftware.org/is/6/innosetup-$innosetupVersion.exe"
          $installerPath = "$env:TEMP\innosetup-installer.exe"
          
          Write-Host "Downloading Inno Setup $innosetupVersion..."
          Invoke-WebRequest -Uri $innosetupUrl -OutFile $installerPath
          
          Write-Host "Installing Inno Setup..."
          Start-Process -FilePath $installerPath -ArgumentList "/SILENT", "/DIR=C:\Program Files (x86)\Inno Setup 6" -Wait
          
          Write-Host "Adding Inno Setup to PATH..."
          $env:PATH += ";C:\Program Files (x86)\Inno Setup 6"
          Add-Content -Path $env:GITHUB_ENV -Value "PATH=$env:PATH;C:\Program Files (x86)\Inno Setup 6"
          
          # éªŒè¯å®‰è£…
          $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (Test-Path $isccPath) {
            Write-Host "âœ“ Inno Setup installed successfully"
            Write-Host "ISCC.exe path: $isccPath"
          } else {
            Write-Error "Inno Setup installation failed - ISCC.exe not found"
            exit 1
          }
      
      - name: Prepare Windows build environment
        run: |
          # åˆ›å»ºæž„å»ºç›®å½•
          $buildDir = "windows_build"
          New-Item -ItemType Directory -Force -Path $buildDir | Out-Null
          
          # æ£€æŸ¥Flutteræž„å»ºäº§ç‰©
          $flutterBuildPath = "flutter_app\build\windows\x64\runner\Release"
          if (-not (Test-Path $flutterBuildPath)) {
            Write-Error "ERROR: Flutter build output not found at $flutterBuildPath"
            exit 1
          }
          
          Write-Host "Copying Flutter build artifacts..."
          # å¤åˆ¶Flutteræž„å»ºäº§ç‰©åˆ°æž„å»ºç›®å½•
          Copy-Item -Recurse -Force "$flutterBuildPath\*" "$buildDir\" -ErrorAction Stop
          
          Write-Host "Copying additional files from windows directory..."
          # æ£€æŸ¥å¹¶å¤åˆ¶nursor-coreæ–‡ä»¶
          if (-not (Test-Path "windows\nursor-core-amd64.dll")) {
            Write-Error "ERROR: nursor-core-amd64.dll not found in windows directory"
            exit 1
          }
          Copy-Item "windows\nursor-core-amd64.dll" "$buildDir\" -ErrorAction Stop
          
          # å¤åˆ¶wintun.dllï¼ˆå¦‚æžœå­˜åœ¨ï¼Œè¦†ç›–Flutteræž„å»ºä¸­çš„ç‰ˆæœ¬ï¼‰
          if (Test-Path "windows\wintun.dll") {
            Copy-Item "windows\wintun.dll" "$buildDir\" -Force -ErrorAction Stop
            Write-Host "Copied wintun.dll from windows directory"
          } else {
            Write-Host "WARNING: wintun.dll not found in windows directory, using Flutter build version"
          }
          
          # å¤åˆ¶ca.pemæ–‡ä»¶ï¼ˆè¯ä¹¦æ–‡ä»¶ï¼‰
          if (Test-Path "windows\ca.pem") {
            Copy-Item "windows\ca.pem" "$buildDir\" -Force -ErrorAction Stop
            Write-Host "Copied ca.pem from windows directory"
          } else {
            Write-Error "ERROR: ca.pem not found in windows directory"
            exit 1
          }
          
          # å¤åˆ¶logo.icoæ–‡ä»¶ï¼ˆå›¾æ ‡æ–‡ä»¶ï¼‰
          if (Test-Path "windows\logo.ico") {
            Copy-Item "windows\logo.ico" "$buildDir\" -Force -ErrorAction Stop
            Write-Host "Copied logo.ico from windows directory"
          } else {
            Write-Error "ERROR: logo.ico not found in windows directory"
            exit 1
          }
          
          Write-Host "Windows build environment prepared successfully"
          Write-Host "Build directory contents:"
          Get-ChildItem $buildDir | Select-Object Name, Length | Format-Table
      
      - name: Build Windows installer
        working-directory: ./windows_build
        run: |
          # éªŒè¯å¿…éœ€æ–‡ä»¶å­˜åœ¨å¹¶æ£€æµ‹å¯æ‰§è¡Œæ–‡ä»¶å
          Write-Host "Verifying required files in build directory..."
          
          # æ£€æŸ¥ä¸»å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¯èƒ½æ˜¯ nursor_app.exe æˆ–å…¶ä»–åç§°ï¼‰
          $exeFiles = Get-ChildItem -Filter "*.exe" | Where-Object { $_.Name -notlike "*runner*" -and $_.Name -notlike "*flutter*" }
          if ($exeFiles.Count -eq 0) {
            Write-Error "ERROR: No main executable file found (.exe)"
            Write-Host "Available .exe files:"
            Get-ChildItem -Filter "*.exe" | Select-Object Name | Format-Table
            exit 1
          }
          
          # ä½¿ç”¨æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ª .exe æ–‡ä»¶åï¼ˆé€šå¸¸æ˜¯ä¸»åº”ç”¨ï¼‰
          $mainExe = $exeFiles[0].Name
          Write-Host "âœ“ Found main executable: $mainExe"
          
          # éªŒè¯å…¶ä»–å¿…éœ€æ–‡ä»¶
          $requiredFiles = @("logo.ico", "ca.pem", "wintun.dll")
          foreach ($file in $requiredFiles) {
            if (-not (Test-Path $file)) {
              Write-Error "ERROR: Required file not found: $file"
              Write-Host "Available files:"
              Get-ChildItem | Select-Object Name | Format-Table
              exit 1
            }
            Write-Host "âœ“ Found: $file"
          }
          
          # æ£€æŸ¥ Flutter DLL æ–‡ä»¶ï¼ˆå¯é€‰ï¼Œå¦‚æžœä¸å­˜åœ¨ä¼šè­¦å‘Šï¼‰
          $flutterDlls = @("flutter_windows.dll", "nursorcore_plugin.dll", "screen_retriever_plugin.dll", "tray_manager_plugin.dll", "window_manager_plugin.dll")
          foreach ($dll in $flutterDlls) {
            if (Test-Path $dll) {
              Write-Host "âœ“ Found: $dll"
            } else {
              Write-Host "âš  WARNING: Flutter DLL not found: $dll (may be optional)"
            }
          }
          
          # å‡†å¤‡Inno Setupè„šæœ¬ï¼ˆå¤åˆ¶åˆ°æž„å»ºç›®å½•å¹¶æ›´æ–°è·¯å¾„ï¼‰
          $issFile = Get-Content "..\nursor_win_installer.iss" -Raw
          
          # æ›´æ–°ç‰ˆæœ¬å·ï¼ˆç§»é™¤ 'v' å‰ç¼€å¦‚æžœæœ‰ï¼‰
          $version = "${{ needs.detect-version.outputs.version }}"
          if ($version.StartsWith("v")) {
            $version = $version.Substring(1)
          }
          
          # æ›´æ–°Inno Setupè„šæœ¬ä¸­çš„è·¯å¾„ã€ç‰ˆæœ¬å’Œå¯æ‰§è¡Œæ–‡ä»¶å
          $issFile = $issFile -replace "#define MySourcePath.*", "#define MySourcePath `".`""
          $issFile = $issFile -replace "#define MyAppVersion.*", "#define MyAppVersion `"$version`""
          $issFile = $issFile -replace "#define MyIconPath.*", "#define MyIconPath `"logo.ico`""
          
          # æ›´æ–°å¯æ‰§è¡Œæ–‡ä»¶åï¼ˆå¦‚æžœä¸Žé»˜è®¤ä¸åŒï¼‰
          if ($mainExe -ne "nursor_app.exe") {
            Write-Host "Updating executable name from nursor_app.exe to $mainExe"
            $issFile = $issFile -replace "nursor_app\.exe", $mainExe
            $issFile = $issFile -replace "#define MyAppExeName.*", "#define MyAppExeName `"$mainExe`""
          }
          
          # ä¿å­˜æ›´æ–°åŽçš„è„šæœ¬åˆ°æž„å»ºç›®å½•
          $issFile | Set-Content "nursor_win_installer.iss"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          New-Item -ItemType Directory -Force -Path "..\output" | Out-Null
          
          # ä½¿ç”¨å®Œæ•´è·¯å¾„è°ƒç”¨ ISCCï¼ˆä»Žæž„å»ºç›®å½•ï¼‰
          $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (Test-Path $isccPath) {
            Write-Host "Building installer with Inno Setup..."
            & $isccPath "/O..\output" "nursor_win_installer.iss"
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Inno Setup compilation failed with exit code: $LASTEXITCODE"
              exit 1
            }
            Write-Host "Installer built successfully"
            Write-Host "Installer output:"
            Get-ChildItem "..\output" | Select-Object Name, Length | Format-Table
          } else {
            Write-Error "ISCC.exe not found at $isccPath"
            exit 1
          }
      
      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: nursor-installer-windows
          path: output/*.exe
          retention-days: 30
      
      - name: Create GitHub Release (if tag exists)
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'repository_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          files: output/*.exe
          tag_name: ${{ needs.detect-version.outputs.version }}
          name: Release ${{ needs.detect-version.outputs.version }}
          body: |
            ## Windows Installer
            
            Build triggered from: ${{ github.event_name }}
            Flutter ref: ${{ needs.detect-version.outputs.flutter_ref }}
            Core ref: ${{ needs.detect-version.outputs.core_ref }}
          draft: false
          prerelease: false

  build-linux:
    needs: detect-version
    strategy:
      matrix:
        arch: [amd64]
        # æ³¨æ„ï¼šarm64éœ€è¦self-hosted runnerï¼Œæš‚ä¸æ”¯æŒ
        # å¦‚éœ€arm64æ”¯æŒï¼Œè¯·é…ç½®self-hosted runneræˆ–ä½¿ç”¨cross-compilation
      fail-fast: false
    # ä½¿ç”¨ Ubuntu 22.04 æž„å»ºï¼š
    # - Ubuntu 22.04 æœ‰æ›´å¥½çš„ runner å¯ç”¨æ€§ï¼ŒGitHub Actions æä¾›å……è¶³çš„ runner
    # - å¦‚æžœéœ€è¦åœ¨ Ubuntu 20.04 ä¸Šè¿è¡Œï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨ Docker æž„å»ºæ¥ç¡®ä¿ GLib ç‰ˆæœ¬å…¼å®¹æ€§
    # - å¯¹äºŽå¤§å¤šæ•°æƒ…å†µï¼Œåœ¨ 22.04 ä¸Šæž„å»ºçš„åº”ç”¨åœ¨ 20.04 ä¸Šä¹Ÿèƒ½è¿è¡Œ
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout packaging repo
        uses: actions/checkout@v4
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git \
            curl \
            wget \
            unzip \
            ca-certificates
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'  # ä½¿ç”¨ç¨³å®šé€šé“çš„æœ€æ–°ç‰ˆæœ¬ï¼ˆæ”¯æŒ Dart 3.8.1+ï¼‰
          cache: true
          cache-key: 'flutter-:os:-:channel:-:version:-:arch:-'
      
      - name: Download Flutter App
        uses: actions/checkout@v4
        with:
          repository: ${{ env.FLUTTER_REPO }}
          ref: ${{ needs.detect-version.outputs.flutter_ref }}
          path: flutter_app
          token: ${{ secrets.PACKAGING_REPO_TOKEN }}
          fetch-depth: 0
      
      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libglib2.0-dev \
            libblkid1 \
            liblzma5 \
            libsecret-1-dev \
            desktop-file-utils \
            libappindicator3-dev \
            patchelf
      
      - name: Check GLib version (for compatibility)
        run: |
          echo "Checking GLib version for compatibility..."
          GLIB_VERSION=$(pkg-config --modversion glib-2.0)
          echo "GLib version: $GLIB_VERSION"
          echo "This version ensures compatibility with Ubuntu 20.04 and later versions"
      
      - name: Build Flutter App for Linux
        working-directory: ./flutter_app
        run: |
          flutter pub get
          # Flutter ä¼šæ ¹æ®è¿è¡Œå™¨çš„æž¶æž„è‡ªåŠ¨æž„å»ºå¯¹åº”æž¶æž„çš„ç‰ˆæœ¬
          # æ³¨æ„ï¼šGitHub Actions Linux runner åªæ”¯æŒ amd64ï¼Œæ‰€ä»¥è¿™é‡Œæž„å»º x64 ç‰ˆæœ¬
          flutter build linux --release
      
      - name: Download nursor-core for Linux
        run: |
          CORE_REF="${{ needs.detect-version.outputs.core_ref }}"
          ARCH="${{ matrix.arch }}"
          TOKEN="${{ secrets.PACKAGING_REPO_TOKEN }}"
          mkdir -p linux
          
          # ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆéœ€è¦è®¤è¯ï¼Œå› ä¸º release assets æ˜¯ç§æœ‰çš„ï¼‰
          CORE_URL="https://github.com/${{ env.CORE_REPO }}/releases/download/${CORE_REF}/core-linux-${ARCH}"
          echo "Downloading nursor-core from: $CORE_URL"
          
          curl -L \
            -H "Authorization: token ${TOKEN}" \
            -H "Accept: application/octet-stream" \
            -o linux/nursor-core \
            "${CORE_URL}"
          
          if [ ! -f "linux/nursor-core" ] || [ ! -s "linux/nursor-core" ]; then
            echo "ERROR: Failed to download nursor-core or file is empty"
            exit 1
          fi
          
          chmod +x linux/nursor-core
          echo "âœ“ nursor-core downloaded successfully"
          
          # å°è¯•ä¸‹è½½å¹¶éªŒè¯SHA256 checksumï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          CHECKSUM_URL="https://github.com/${{ env.CORE_REPO }}/releases/download/${CORE_REF}/core-linux-${ARCH}.sha256"
          if curl -fsSL \
            -H "Authorization: token ${TOKEN}" \
            -H "Accept: application/octet-stream" \
            "${CHECKSUM_URL}" > /tmp/checksum.sha256 2>/dev/null; then
            echo "Verifying SHA256 checksum..."
            (cd linux && sha256sum -c --quiet <(cat /tmp/checksum.sha256 | tr -d '\r\n' | awk '{print $1"  nursor-core"}')) || {
              echo "ERROR: SHA256 checksum verification failed"
              exit 1
            }
            echo "âœ“ SHA256 checksum verified successfully"
          else
            echo "âš  WARNING: SHA256 checksum file not found, skipping verification"
          fi
      
      - name: Package Linux installer
        id: package_installer
        run: |
          ARCH="${{ matrix.arch }}"
          RAW_VERSION="${{ needs.detect-version.outputs.version }}"
          
          # æ¸…ç†ç‰ˆæœ¬å·ï¼šç§»é™¤ 'v' å‰ç¼€å’Œå…¶ä»–ç‰¹æ®Šå­—ç¬¦
          PACKAGE_VERSION=$(echo "$RAW_VERSION" | sed 's/^v//' | sed 's/[^a-zA-Z0-9._-]//g')
          
          echo "Raw version: $RAW_VERSION"
          echo "Cleaned version: $PACKAGE_VERSION"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•ï¼ˆä½¿ç”¨ç»å¯¹è·¯å¾„ç¡®ä¿å­˜åœ¨ï¼‰
          OUTPUT_DIR="$(pwd)/output"
          mkdir -p "$OUTPUT_DIR"
          
          # éªŒè¯è¾“å‡ºç›®å½•æ˜¯å¦åˆ›å»ºæˆåŠŸ
          if [ ! -d "$OUTPUT_DIR" ]; then
            echo "ERROR: Failed to create output directory: $OUTPUT_DIR"
            exit 1
          fi
          echo "Output directory: $OUTPUT_DIR"
          
          # åˆ›å»ºä¸´æ—¶æ‰“åŒ…ç›®å½•
          TEMP_DIR="$(pwd)/linux_appimage"
          mkdir -p "$TEMP_DIR/usr/bin"
          mkdir -p "$TEMP_DIR/usr/share/applications"
          mkdir -p "$TEMP_DIR/usr/share/icons"
          
          # Flutter Linux æž„å»ºè¾“å‡ºè·¯å¾„ï¼ˆGitHub Actions Linux runner é€šå¸¸æ˜¯ x64ï¼‰
          # Flutter ä¼šè‡ªåŠ¨æž„å»ºåˆ° build/linux/x64/release/bundle
          FLUTTER_BUILD_PATH="flutter_app/build/linux/x64/release/bundle"
          
          # æ£€æŸ¥ Flutter æž„å»ºè¾“å‡ºæ˜¯å¦å­˜åœ¨
          if [ ! -d "$FLUTTER_BUILD_PATH" ]; then
            echo "ERROR: Flutter build output not found at $FLUTTER_BUILD_PATH"
            echo "Current directory: $(pwd)"
            echo "Available directories in flutter_app/build/linux:"
            find flutter_app/build/linux -type d -maxdepth 3 2>/dev/null || echo "Directory flutter_app/build/linux not found"
            exit 1
          fi
          
          echo "Copying Flutter build artifacts from $FLUTTER_BUILD_PATH..."
          cp -R "$FLUTTER_BUILD_PATH"/* "$TEMP_DIR/"
          
          # å¤åˆ¶ nursor-core äºŒè¿›åˆ¶æ–‡ä»¶
          if [ ! -f "linux/nursor-core" ]; then
            echo "ERROR: nursor-core not found in linux/ directory"
            echo "Current directory: $(pwd)"
            echo "Files in linux directory:"
            ls -lah linux/ 2>/dev/null || echo "linux directory does not exist"
            exit 1
          fi
          cp linux/nursor-core "$TEMP_DIR/nursor-core"
          chmod +x "$TEMP_DIR/nursor-core"
          
          # åˆ›å»º.desktopæ–‡ä»¶
          mkdir -p "$TEMP_DIR/usr/share/applications"
          cat > "$TEMP_DIR/usr/share/applications/nursor.desktop" <<'EOF'
          [Desktop Entry]
          Version=1.0
          Type=Application
          Name=Nursor
          Exec=nursor
          Icon=nursor
          Categories=Utility;
          EOF
          
          # éªŒè¯æ‰“åŒ…å†…å®¹
          echo "Package contents in $TEMP_DIR:"
          ls -lah "$TEMP_DIR" | head -20
          echo ""
          
          # åˆ›å»ºtar.gzåŒ…ï¼ˆä½¿ç”¨å®Œæ•´è·¯å¾„ï¼‰
          PACKAGE_NAME="nursor-linux-${ARCH}-${PACKAGE_VERSION}.tar.gz"
          OUTPUT_PATH="${OUTPUT_DIR}/${PACKAGE_NAME}"
          
          echo "Creating package: $OUTPUT_PATH"
          echo "Source directory: $TEMP_DIR"
          
          # ç¡®ä¿åœ¨æ­£ç¡®çš„ç›®å½•æ‰§è¡Œ tar å‘½ä»¤
          cd "$TEMP_DIR" || exit 1
          
          # åˆ›å»º tar.gz åŒ…
          if tar -czf "$OUTPUT_PATH" . 2>&1; then
            echo "âœ“ tar command completed successfully"
          else
            echo "ERROR: tar command failed"
            exit 1
          fi
          
          # è¿”å›žåŽŸå§‹ç›®å½•
          cd - > /dev/null
          
          # éªŒè¯æ–‡ä»¶æ˜¯å¦åˆ›å»ºæˆåŠŸ
          if [ ! -f "$OUTPUT_PATH" ]; then
            echo "ERROR: Package file not created: $OUTPUT_PATH"
            echo "Output directory contents:"
            ls -lah "$OUTPUT_DIR" || echo "Output directory does not exist"
            exit 1
          fi
          
          FILE_SIZE=$(stat -c%s "$OUTPUT_PATH" 2>/dev/null || echo "unknown")
          echo "âœ“ Package created successfully: $OUTPUT_PATH (size: $FILE_SIZE bytes)"
          ls -lh "$OUTPUT_PATH"
          
          echo "package_created=true" >> $GITHUB_OUTPUT
          echo "package_path=$OUTPUT_PATH" >> $GITHUB_OUTPUT
      
      - name: Record build status
        if: always()
        run: |
          echo "Build status for ${{ matrix.arch }}: ${{ job.status }}" >> build_status.txt
      
      - name: Upload Linux installer
        uses: actions/upload-artifact@v4
        with:
          name: nursor-installer-linux-${{ matrix.arch }}
          path: output/*.tar.gz
          retention-days: 30
      
      - name: Create GitHub Release (if tag exists)
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'repository_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          files: output/*.tar.gz
          tag_name: ${{ needs.detect-version.outputs.version }}
          name: Release ${{ needs.detect-version.outputs.version }}
          body: |
            ## Linux Installer - ${{ matrix.arch }}
            
            Build triggered from: ${{ github.event_name }}
            Flutter ref: ${{ needs.detect-version.outputs.flutter_ref }}
            Core ref: ${{ needs.detect-version.outputs.core_ref }}
          draft: false
          prerelease: false

  notify-completion:
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## ðŸ“¦ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### macOS" >> $GITHUB_STEP_SUMMARY
          echo "- amd64: ${{ needs.build-macos.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- arm64: ${{ needs.build-macos.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Windows" >> $GITHUB_STEP_SUMMARY
          echo "- amd64: ${{ needs.build-windows.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Linux" >> $GITHUB_STEP_SUMMARY
          echo "- amd64: ${{ needs.build-linux.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- arm64: âš ï¸ Not supported (requires self-hosted runner)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Status:** ${{ needs.build-macos.result == 'success' && needs.build-windows.result == 'success' && needs.build-linux.result == 'success' && 'âœ… All builds succeeded' || 'âŒ Some builds failed' }}" >> $GITHUB_STEP_SUMMARY

